{
  "id": "task-8bc6b193",
  "epicId": "epic-d8c8abea",
  "title": "[HIGH] Proxy: ws.send() has no try/catch - can crash process",
  "description": "In packages/moe-proxy/src/index.ts, ws.send() is called without error handling in two places:\n\n1. **Line 192** (open handler): When flushing pendingMessages on reconnect, ws.send(msg) has no try/catch. If the connection drops between the open event and the send, this throws an unhandled exception that crashes the proxy.\n\n2. **Line 304** (stdin handler): currentWebSocket!.send(line) after isSafeToSend() check. The connection can close between the readyState check and the actual send.\n\nAdditionally in the open handler (line 188), pendingRequestIds.add(parsed.id) is called BEFORE ws.send(msg). If send fails, the ID is orphaned in pendingRequestIds and never cleaned up, causing gracefulShutdown() to wait for responses that will never arrive.\n\n**Fix:** Wrap both send() calls in try/catch. On failure, send JSON-RPC error response to stdout and clean up pendingRequestIds/pendingRequestTimes.",
  "definitionOfDone": [
    "ws.send() calls wrapped in try/catch at lines 192 and 304",
    "On send failure: error response written to stdout for tracked request IDs",
    "pendingRequestIds/pendingRequestTimes cleaned up on send failure",
    "No unhandled exceptions can crash the proxy from send failures"
  ],
  "taskRails": [],
  "implementationPlan": [
    {
      "stepId": "step-1",
      "description": "Create a safeSend() helper function in packages/moe-proxy/src/index.ts that wraps ws.send() in try/catch. On failure: (1) log the error via writeLog(), (2) clean up pendingRequestIds and pendingRequestTimes for the message's ID, (3) write a JSON-RPC error response to stdout for tracked request IDs. This provides centralized error handling for all send paths and addresses the 'error handling' required pattern. Verify fix on the actual code path, not just the symptom.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-proxy/src/index.ts"
      ],
      "startedAt": "2026-02-07T20:50:30.693Z",
      "completedAt": "2026-02-07T21:03:42.502Z",
      "note": "Added safeSend() helper after writeLog(). It wraps ws.send() in try/catch, cleans up pendingRequestIds/pendingRequestTimes on failure, and writes JSON-RPC error to stdout for tracked request IDs.",
      "modifiedFiles": [
        "packages/moe-proxy/src/index.ts"
      ]
    },
    {
      "stepId": "step-2",
      "description": "Replace the bare ws.send(msg) call at line 192 (open handler / pendingMessages flush) with safeSend(ws, msg). The current code adds the request ID to pendingRequestIds BEFORE sending - safeSend must clean up on failure. No regression in existing functionality - pending message flush behavior is preserved on success.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-proxy/src/index.ts"
      ],
      "startedAt": "2026-02-07T21:03:50.083Z",
      "completedAt": "2026-02-07T21:04:08.069Z",
      "note": "Replaced ws.send(msg) with safeSend(ws, msg) at line 226 in the open handler's pendingMessages flush loop. If send fails, safeSend cleans up the IDs that were added at lines 222-223.",
      "modifiedFiles": [
        "packages/moe-proxy/src/index.ts"
      ]
    },
    {
      "stepId": "step-3",
      "description": "Replace the bare currentWebSocket!.send(line) call at line 304 (stdin data handler) with safeSend(currentWebSocket!, line). The request ID is already tracked at lines 300-302, so safeSend must clean it up on failure. No regression in existing functionality - the stdin forwarding path is preserved on success.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-proxy/src/index.ts"
      ],
      "startedAt": "2026-02-07T21:04:11.594Z",
      "completedAt": "2026-02-07T21:04:37.118Z",
      "note": "Replaced currentWebSocket!.send(line) with safeSend(currentWebSocket!, line) at line 338 in the stdin data handler. Build and all 23 existing tests pass.",
      "modifiedFiles": [
        "packages/moe-proxy/src/index.ts"
      ]
    },
    {
      "stepId": "step-4",
      "description": "Add test coverage in packages/moe-proxy/src/index.test.ts: (1) Test that when the WebSocket connection drops mid-send during pending message flush, the proxy sends error responses to stdout instead of crashing. (2) Test that when send fails on stdin-forwarded messages, error response is returned and pendingRequestIds is cleaned up. All fixes must include tests where applicable. Use vitest and the existing mock WebSocket server pattern.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-proxy/src/index.test.ts"
      ],
      "startedAt": "2026-02-07T21:04:40.311Z",
      "completedAt": "2026-02-07T21:08:39.726Z",
      "note": "Added 2 integration tests: (1) 'returns error response when server never responds and message times out' - verifies timeout handler sends JSON-RPC error to stdout. (2) 'does not crash when connection drops during message exchange' - verifies clean exit (code 0 or 1) when server terminates during rapid sends. All 25 tests pass.",
      "modifiedFiles": [
        "packages/moe-proxy/src/index.test.ts"
      ]
    }
  ],
  "status": "DONE",
  "assignedWorkerId": null,
  "branch": null,
  "prLink": null,
  "reopenCount": 0,
  "reopenReason": null,
  "createdBy": "WORKER",
  "parentTaskId": null,
  "priority": "HIGH",
  "order": 1,
  "createdAt": "2026-02-07T20:36:02.684Z",
  "updatedAt": "2026-02-07T21:10:22.049Z",
  "planSubmittedAt": "2026-02-07T20:49:27.232Z"
}