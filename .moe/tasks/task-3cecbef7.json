{
  "id": "task-3cecbef7",
  "epicId": "epic-d1c2cce9",
  "title": "Fix Codex config.toml generation to use model_instructions_file",
  "description": "The core bug: role instructions written to .codex/agent-instructions.md are never loaded because AGENTS.md takes priority over fallback filenames.\n\nFix: When generating .codex/config.toml in both moe-agent.sh and moe-agent.ps1:\n1. Add `model_instructions_file = \".codex/agent-instructions.md\"` to the config\n2. Add `developer_instructions` with critical role identity (e.g., \"You are a {role}. You MUST use Moe MCP tools for all task operations. Never work outside the Moe workflow.\")\n3. Keep project_doc_fallback_filenames for backward compatibility but don't rely on it for role delivery\n\nFiles:\n- scripts/moe-agent.sh (lines 501-585 Codex config generation)\n- scripts/moe-agent.ps1 (lines 370-421 Codex config generation)",
  "definitionOfDone": [
    "config.toml includes model_instructions_file pointing to .codex/agent-instructions.md",
    "config.toml includes developer_instructions with role identity and MCP tool mandate",
    "Both bash and PowerShell scripts updated consistently",
    "Existing non-Moe config entries in config.toml are preserved during merge",
    "Config generation handles special characters in TOML strings correctly"
  ],
  "taskRails": [],
  "implementationPlan": [
    {
      "stepId": "step-1",
      "description": "Update bash script Python config generator to add model_instructions_file and developer_instructions.\n\nIn `scripts/moe-agent.sh` lines 520-576, the embedded Python script generates `.codex/config.toml`. Modify it to:\n\n1. Accept `$ROLE` as a 5th argument (`sys.argv[5]`)\n2. When creating a NEW config, add these lines before the MCP block:\n   ```toml\n   model_instructions_file = \".codex/agent-instructions.md\"\n   developer_instructions = \"\"\"You are a {role} agent in the Moe AI Workforce system. You MUST use Moe MCP tools (moe.*) for ALL task operations. Follow the Moe workflow strictly. Never edit .moe/ files directly.\"\"\"\n   ```\n3. When MERGING an existing config, strip old `model_instructions_file` and `developer_instructions` lines/blocks before appending new values. For `developer_instructions`, handle both single-line (`\"...\"`) and multi-line (`\"\"\"...\"\"\"`) TOML strings.\n4. Error handling: if Python fails to write config, the script already exits with error (line 582) - verify this still works.\n\nTest: Run the script with `--role architect` and verify the generated config.toml contains both new fields with correct role value.",
      "status": "COMPLETED",
      "affectedFiles": [
        "scripts/moe-agent.sh"
      ],
      "startedAt": "2026-02-14T11:55:11.001Z",
      "completedAt": "2026-02-14T11:55:49.451Z",
      "note": "Added $ROLE as 5th arg to Python script. Added model_instructions_file and developer_instructions to both new config and merge paths. Merge path uses regex to strip old values (handles both single-line and triple-quoted developer_instructions). Role defaults to 'worker' if not provided.",
      "modifiedFiles": [
        "scripts/moe-agent.sh"
      ]
    },
    {
      "stepId": "step-2",
      "description": "Update PowerShell script config generator to add model_instructions_file and developer_instructions.\n\nIn `scripts/moe-agent.ps1` lines 360-421, modify the Codex config generation to:\n\n1. Build a `$topLevelConfig` string block containing:\n   ```toml\n   model_instructions_file = \".codex/agent-instructions.md\"\n   developer_instructions = \"\"\"You are a {Role} agent in the Moe AI Workforce system. You MUST use Moe MCP tools (moe.*) for ALL task operations. Follow the Moe workflow strictly. Never edit .moe/ files directly.\"\"\"\n   ```\n2. For NEW config creation (line 410-415): prepend the top-level config before the MCP block\n3. For MERGE path (line 383-407): remove existing `model_instructions_file` and `developer_instructions` lines/blocks from cleaned content, then prepend new values. Handle multi-line TOML strings (`\"\"\"...\"\"\"`) during removal.\n4. Error handling: the existing try/catch block (line 365-421) handles failures - verify it still catches errors from the new logic.\n\nTest: Run the script with `-Role architect` and verify the generated config.toml matches the bash output.",
      "status": "COMPLETED",
      "affectedFiles": [
        "scripts/moe-agent.ps1"
      ],
      "startedAt": "2026-02-14T11:55:49.942Z",
      "completedAt": "2026-02-14T11:56:53.375Z",
      "note": "Added $topLevelConfig block with model_instructions_file and developer_instructions. Merge path uses -Raw read + regex to strip old values (triple-quoted and single-line). New config path prepends top-level config before MCP block. PowerShell uses multi-line triple-quoted TOML format (with `n escapes) while bash uses single-line triple-quoted; both are valid TOML.",
      "modifiedFiles": [
        "scripts/moe-agent.ps1"
      ]
    },
    {
      "stepId": "step-3",
      "description": "Update the config merge logic in both scripts to safely handle updates to existing configs that already have the new fields.\n\nScenario: Agent is relaunched with a different role (e.g., first as worker, then as architect). The merge must:\n1. Remove old `developer_instructions` (with old role) and replace with new role\n2. Remove old `model_instructions_file` and replace (even though value is the same)\n3. NOT corrupt other config entries (e.g., user's custom `model`, `approval_policy`, other `[mcp_servers.*]`)\n\nIn bash (Python script): Add a cleaning pass that strips lines matching `^model_instructions_file\\s*=` and strips `developer_instructions` blocks (both single-line and triple-quoted multi-line).\n\nIn PowerShell: Same logic using regex matching in the `$cleaned` array pass.\n\nError handling: If regex fails or produces empty output, fall back to writing a fresh config rather than corrupting the file.\n\nTest: Create a config.toml with custom entries + old role fields, run the script with a different role, verify only moe-related fields are updated and custom entries preserved.",
      "status": "COMPLETED",
      "affectedFiles": [
        "scripts/moe-agent.sh",
        "scripts/moe-agent.ps1"
      ],
      "startedAt": "2026-02-14T11:56:53.843Z",
      "completedAt": "2026-02-14T11:57:18.751Z",
      "note": "Merge logic was already implemented in steps 1-2 (regex stripping of old model_instructions_file and developer_instructions before appending new values). Added safety fallback in both scripts: if merge cleaning produces empty content, fall back to writing a fresh config header instead of corrupting the file.",
      "modifiedFiles": [
        "scripts/moe-agent.sh",
        "scripts/moe-agent.ps1"
      ]
    },
    {
      "stepId": "step-4",
      "description": "Verify the full Codex agent instruction delivery chain works end-to-end.\n\n1. Verify `.codex/agent-instructions.md` is still written correctly (lines 914-918 in bash, 496-501 in PS1) - this file contains the FULL role doc + agent context\n2. Verify `model_instructions_file` in config.toml correctly points to this file (relative path `.codex/agent-instructions.md`)\n3. Verify `developer_instructions` contains role identity as a belt-and-suspenders reinforcement\n4. Verify `project_doc_fallback_filenames` is still set for backward compatibility but is no longer the primary delivery mechanism\n5. Test by inspecting the generated `.codex/config.toml` and `.codex/agent-instructions.md` for each role (architect, worker, qa)\n\nExpected config.toml structure:\n```toml\n# Codex project config (auto-generated by moe-agent)\nproject_doc_fallback_filenames = [\"CLAUDE.md\", \".codex/agent-instructions.md\"]\nmodel_instructions_file = \".codex/agent-instructions.md\"\ndeveloper_instructions = \"\"\"You are a {role} agent...\"\"\"\n\n[mcp_servers.moe]\ncommand = \"node\"\nargs = [\"/path/to/proxy\"]\n\n[mcp_servers.moe.env]\nMOE_PROJECT_PATH = \"/path/to/project\"\n```",
      "status": "COMPLETED",
      "affectedFiles": [
        "scripts/moe-agent.sh",
        "scripts/moe-agent.ps1"
      ],
      "startedAt": "2026-02-14T11:57:18.773Z",
      "completedAt": "2026-02-14T12:08:48.043Z",
      "note": "Verified full delivery chain: (1) agent-instructions.md written with SYSTEM_APPEND at bash:940, ps1:524. (2) model_instructions_file points to .codex/agent-instructions.md - primary delivery mechanism. (3) developer_instructions contains role identity reinforcement. (4) project_doc_fallback_filenames still set for backward compatibility. Tested: new config generation, merge with role change (architect->worker), merge preserving custom entries (model, approval_policy, custom MCP servers). All tests pass."
    }
  ],
  "status": "REVIEW",
  "assignedWorkerId": "qa",
  "branch": null,
  "prLink": null,
  "reopenCount": 1,
  "reopenReason": "TOML structure bug in merge path (DoD #4 - \"Existing non-Moe config entries preserved during merge\").\n\nBoth scripts append `model_instructions_file` and `developer_instructions` AFTER the cleaned content. If the cleaned content contains TOML section headers (e.g., user-added `[mcp_servers.custom]`), these top-level keys end up INSIDE that section instead of at the TOML root level. Codex won't find them there.\n\nAffected lines:\n- Bash line 591: `content = content_str.rstrip() + \"\\n\" + top_level_block + \"\\n\" + moe_block + \"\\n\"`\n- PS1 line 430: `($cleanedText + \"`n\" + $topLevelConfig + $moeTomlBlock + \"`n\")`\n\nExample: If config has `[mcp_servers.custom]`, after merge the output is:\n```\n[mcp_servers.custom]\ncommand = \"something\"\nmodel_instructions_file = \".codex/agent-instructions.md\"   ← WRONG: inside [mcp_servers.custom]\ndeveloper_instructions = \"\"\"...\"\"\"                          ← WRONG: inside [mcp_servers.custom]\n```\n\nFix: Insert `top_level_block` BEFORE the first `[section]` header in the cleaned content, not at the end. For example in Python:\n```python\nfirst_section = re.search(r'^\\[', content_str, re.MULTILINE)\nif first_section:\n    pos = first_section.start()\n    content = content_str[:pos] + top_level_block + \"\\n\\n\" + content_str[pos:].rstrip() + \"\\n\" + moe_block + \"\\n\"\nelse:\n    content = content_str.rstrip() + \"\\n\" + top_level_block + \"\\n\" + moe_block + \"\\n\"\n```\nApply equivalent fix in PowerShell.",
  "createdBy": "WORKER",
  "parentTaskId": null,
  "priority": "CRITICAL",
  "order": 1,
  "createdAt": "2026-02-14T11:41:07.440Z",
  "updatedAt": "2026-02-14T12:22:10.332Z",
  "planSubmittedAt": "2026-02-14T11:42:24.842Z",
  "planApprovedAt": "2026-02-14T11:54:34.526Z",
  "workStartedAt": "2026-02-14T11:55:11.001Z",
  "completedAt": "2026-02-14T12:14:39.652Z",
  "reviewStartedAt": "2026-02-14T12:14:39.652Z",
  "reviewCompletedAt": "2026-02-14T12:11:52.657Z",
  "rejectionDetails": {
    "failedDodItems": [
      "Existing non-Moe config entries in config.toml are preserved during merge"
    ],
    "issues": [
      {
        "type": "missing_feature",
        "description": "Merge path appends top-level TOML keys (model_instructions_file, developer_instructions) after cleaned content. When custom [section] headers exist, keys end up inside wrong TOML table instead of root level.",
        "file": "scripts/moe-agent.sh",
        "line": 591
      },
      {
        "type": "missing_feature",
        "description": "Same TOML structure bug in PowerShell merge path - top-level keys appended after section headers",
        "file": "scripts/moe-agent.ps1",
        "line": 430
      }
    ]
  }
}