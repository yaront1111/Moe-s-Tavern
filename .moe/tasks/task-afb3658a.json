{
  "id": "task-afb3658a",
  "epicId": "epic-be924fb8",
  "title": "Daemon graceful shutdown hardening",
  "description": "httpServer.close() (index.ts line 368) not awaited - data loss during shutdown. Lock file not released on crash - blocks future starts. No DAEMON_SHUTTING_DOWN message to plugin clients before close.",
  "definitionOfDone": [
    "httpServer.close() is properly awaited during shutdown",
    "Lock file released in normal shutdown and force-exit (uncaughtException/unhandledRejection)",
    "Plugin clients receive DAEMON_SHUTTING_DOWN message before WebSocket close",
    "SIGTERM results in clean shutdown with no stale lock file",
    "npm test passes with no regressions"
  ],
  "taskRails": [],
  "implementationPlan": [
    {
      "stepId": "step-1",
      "description": "Promisify httpServer.close() and await it in shutdown. At line ~368 in index.ts, `httpServer.close()` is fire-and-forget. Wrap it in a Promise: `await new Promise<void>((resolve) => { httpServer.close(() => resolve()); })`. Add a timeout (5 seconds) so shutdown doesn't hang if connections don't drain. Move this after `wsServer.close()` since WebSocket connections should close first (they ride on the HTTP server). Error handling: wrap in try-catch consistent with existing shutdown blocks.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-daemon/src/index.ts"
      ],
      "completedAt": "2026-02-18T23:06:02.808Z",
      "note": "Added awaited HTTP shutdown path with timeout: introduced closeHttpServer(server, timeoutMs) that wraps httpServer.close() in a Promise, handles ERR_SERVER_NOT_RUNNING, and enforces a 5s timeout (configurable via MOE_HTTP_CLOSE_TIMEOUT_MS). shutdown() now awaits closeHttpServer after wsServer.close(), with existing try/catch error handling preserved.",
      "modifiedFiles": [
        "packages/moe-daemon/src/index.ts"
      ]
    },
    {
      "stepId": "step-2",
      "description": "Send DAEMON_SHUTTING_DOWN message to plugin clients before closing WebSocket. In WebSocketServer.ts `close()` method (line ~572), before closing client connections, broadcast a `{ type: 'DAEMON_SHUTTING_DOWN' }` message to all plugin clients using safeSend. This gives the plugin a chance to update its UI (show 'Daemon shutting down...' status) before the connection drops. Add a small delay (100ms) after sending to allow messages to flush before close(). Error handling: safeSend already handles closed connections gracefully.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-daemon/src/server/WebSocketServer.ts"
      ],
      "startedAt": "2026-02-18T23:06:06.120Z",
      "completedAt": "2026-02-18T23:06:42.920Z",
      "note": "Hardened WebSocket shutdown flow: close() now sends `{type:'DAEMON_SHUTTING_DOWN'}` to all plugin clients via safeSend, waits 100ms for flush (with unrefâ€™d timer), then closes plugin/MCP sockets and finally awaits wss.close().",
      "modifiedFiles": [
        "packages/moe-daemon/src/server/WebSocketServer.ts"
      ]
    },
    {
      "stepId": "step-3",
      "description": "Handle DAEMON_SHUTTING_DOWN in plugin. In MoeProjectService.kt, add handling for the DAEMON_SHUTTING_DOWN message type in the message handler. When received: set `isManualDisconnect = true` (prevents auto-reconnect), update status to 'Daemon shutting down...', and call stopAutoRefresh(). This prevents the plugin from trying to reconnect during a clean shutdown. Error handling: if the message arrives after other shutdown cleanup, it's safely ignored.",
      "status": "COMPLETED",
      "affectedFiles": [
        "moe-jetbrains/src/main/kotlin/com/moe/services/MoeProjectService.kt"
      ],
      "startedAt": "2026-02-18T23:06:46.192Z",
      "completedAt": "2026-02-18T23:07:05.043Z",
      "note": "Added DAEMON_SHUTTING_DOWN message handling in plugin service: sets isManualDisconnect=true to suppress reconnect attempts during clean daemon shutdown, stops auto-refresh polling, and updates UI status to 'Daemon shutting down...'.",
      "modifiedFiles": [
        "moe-jetbrains/src/main/kotlin/com/moe/services/MoeProjectService.kt"
      ]
    },
    {
      "stepId": "step-4",
      "description": "Add lock file release in uncaughtException handler. At line ~400 in index.ts, the uncaughtException handler calls shutdown() which already calls removeDaemonInfo. But add an explicit `releaseLock(projectPath)` call in the uncaughtException handler as a safety net BEFORE calling shutdown(), in case shutdown() itself crashes. Also add the same to the forceExitTimeout callback (line ~352) which calls process.exit(1) without cleanup. Wrap in try-catch to avoid masking the original error.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-daemon/src/index.ts"
      ],
      "startedAt": "2026-02-18T23:07:08.331Z",
      "completedAt": "2026-02-18T23:07:36.714Z",
      "note": "Added lock-file cleanup safety nets on crash/forced exit paths. forceExitTimeout now attempts releaseLock(projectPath) (and daemon info cleanup) before process.exit(1), both guarded with try/catch logging. uncaughtException handler now explicitly calls releaseLock(projectPath) before invoking shutdown(). Verified daemon package compiles via `npm run build`.",
      "modifiedFiles": [
        "packages/moe-daemon/src/index.ts"
      ]
    },
    {
      "stepId": "step-5",
      "description": "Add tests for shutdown behavior. Test cases using vitest: (1) httpServer.close() is awaited (mock server, verify promise-based close), (2) DAEMON_SHUTTING_DOWN message is sent to all plugin clients before WebSocket close, (3) Lock file is cleaned up after shutdown, (4) Multiple shutdown calls are idempotent (isShuttingDown guard). Run npm test to verify no regressions.",
      "status": "COMPLETED",
      "affectedFiles": [
        "packages/moe-daemon/src/server/WebSocketServer.test.ts"
      ],
      "completedAt": "2026-02-18T23:09:36.956Z",
      "note": "Added shutdown regression tests and supporting hardening:\n- WebSocketServer.test.ts now verifies DAEMON_SHUTTING_DOWN is delivered to plugin clients before socket close.\n- Added idempotency test for repeated WebSocketServer.close() calls.\n- Updated test teardown to await wsServer.close() when needed.\n- Hardened WebSocketServer.close() with closePromise guards so concurrent/repeated close calls are safe and deterministic.\n\nVerification:\n- `npx vitest run src/server/WebSocketServer.test.ts`\n- `npx vitest run` (daemon full suite)\n- `./gradlew.bat test` (plugin compile/test task)\nAll passed.",
      "modifiedFiles": [
        "packages/moe-daemon/src/server/WebSocketServer.ts",
        "packages/moe-daemon/src/server/WebSocketServer.test.ts"
      ]
    }
  ],
  "status": "DONE",
  "assignedWorkerId": null,
  "branch": null,
  "prLink": null,
  "reopenCount": 0,
  "reopenReason": null,
  "createdBy": "WORKER",
  "parentTaskId": null,
  "priority": "HIGH",
  "order": 3,
  "comments": [],
  "hasPendingQuestion": false,
  "createdAt": "2026-02-18T22:27:38.026Z",
  "updatedAt": "2026-02-19T07:30:14.891Z",
  "planSubmittedAt": "2026-02-18T22:29:21.441Z",
  "planApprovedAt": "2026-02-18T22:29:35.696Z",
  "workStartedAt": "2026-02-18T23:06:06.120Z",
  "completedAt": "2026-02-18T23:09:46.019Z",
  "reviewStartedAt": "2026-02-18T23:09:46.019Z",
  "reviewCompletedAt": "2026-02-19T07:30:14.891Z"
}