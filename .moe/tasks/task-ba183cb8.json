{
  "id": "task-ba183cb8",
  "epicId": "epic-ffe3ace6",
  "title": "Agent launching via VS Code terminal API",
  "description": "Implement agent launching from the VS Code extension, matching JetBrains TerminalAgentLauncher.kt. Users need to start architect, worker, and qa agents directly from the IDE.\n\n**Create src/util/AgentLauncher.ts:**\n\n**Agent provider enum (matching TerminalAgentLauncher.AgentProvider):**\n- CLAUDE (command: \"claude\")\n- CODEX (command: \"codex\")\n- GEMINI (command: \"gemini\")\n- CUSTOM (command: user-provided)\n\n**Core launch function:**\n- Use VS Code Terminal API: vscode.window.createTerminal({ name, cwd, env })\n- Terminal name follows pattern: \"Moe Planner\" (architect), \"Moe Coder\" (worker), \"Moe QA\" (qa)\n- Working directory: workspace root\n- Send the agent script command to the terminal via terminal.sendText()\n\n**Agent script resolution (matching TerminalAgentLauncher.resolveAgentScript):**\n1. Check workspace for scripts/moe-agent.ps1 (Windows) or scripts/moe-agent.sh (Unix)\n2. Check bundled scripts in extension path\n3. Check global config (~/.moe/config.json installPath)\n4. Fail with error message if not found\n\n**Command building (matching buildPowerShellCommand / buildBashCommand):**\n- Windows: PowerShell command invoking moe-agent.ps1 with -Role, -Project, -WorkerId, -Command, optional -Team\n- Unix: bash command invoking moe-agent.sh with --role, --project, --worker-id, --command, optional --team\n- WorkerId generated as \"{role}-{random4chars}\"\n- Environment overrides for MOE_DAEMON_PATH and MOE_PROXY_PATH when using bundled/global scripts\n\n**Team mode (matching TerminalAgentLauncher team mode):**\n- Store team mode enabled/disabled in VS Code workspace settings or extension state\n- When enabled, pass team name (project name) to agent script\n- Toggle via the agents menu\n\n**UI Integration - \"Start Agents\" button in board header:**\n- Add a button/dropdown matching JetBrains MoeToolWindowPanel.kt lines 127-198\n- Click shows a popup/quick pick menu with options:\n  - Team Mode toggle (checkbox)\n  - \"Start All Agents\" (launches architect + worker + qa with 1.5s delay between)\n  - \"Start Architect\" submenu with provider selection (Claude/Codex/Gemini/Custom)\n  - \"Start Worker\" submenu with provider selection\n  - \"Start QA\" submenu with provider selection\n- Each provider option launches with that provider's command\n- Custom option prompts for command via vscode.window.showInputBox\n\n**Settings persistence:**\n- Last used provider stored in workspace state\n- Custom command stored in workspace state\n- Team mode enabled stored in workspace state\n\n**Commands to register:**\n- moe.startAgents - Start all agents\n- moe.startAgent - Start single agent (with role parameter)\n\nReference: JetBrains TerminalAgentLauncher.kt for the complete implementation.",
  "definitionOfDone": [
    "Start Agents button in board header with dropdown menu",
    "Menu shows team mode toggle + start all/architect/worker/qa options",
    "Each role option has provider submenu (Claude/Codex/Gemini/Custom)",
    "Agents launch in VS Code terminal with correct script and arguments",
    "Agent script resolved from project, bundled, or global config paths",
    "Windows uses PowerShell command, Unix uses bash command",
    "Worker IDs generated with role prefix and random suffix",
    "Team mode passes team name when enabled",
    "Last used provider and custom command persisted in workspace state",
    "moe.startAgents and moe.startAgent commands registered"
  ],
  "taskRails": [],
  "implementationPlan": [
    {
      "stepId": "step-1",
      "description": "Create `moe-vscode/src/util/AgentLauncher.ts` with the core agent launching logic.\n\n**Exports:**\n- `type AgentProvider = 'claude' | 'codex' | 'gemini' | 'custom'`\n- `type AgentRole = 'architect' | 'worker' | 'qa'`\n- `function launchAgent(role: AgentRole, provider: AgentProvider, extensionPath: string, customCommand?: string): void`\n- `function launchAllAgents(provider: AgentProvider, extensionPath: string, customCommand?: string): void`\n\n**`launchAgent` implementation:**\n1. Resolve workspace root from `vscode.workspace.workspaceFolders[0]`\n2. Resolve agent script path via `resolveAgentScript(extensionPath, workspacePath)`\n3. Generate workerId: `{role}-${randomHex(4)}`\n4. Determine command: provider name or customCommand for 'custom'\n5. Determine if Windows: `process.platform === 'win32'`\n6. Build terminal command string (PowerShell or bash)\n7. Create terminal: `vscode.window.createTerminal({ name: terminalName(role), cwd: workspacePath })`\n8. Send command via `terminal.sendText(command)`\n9. Show terminal: `terminal.show()`\n\n**Terminal names:** 'Moe Planner' (architect), 'Moe Coder' (worker), 'Moe QA' (qa)\n\n**`launchAllAgents`:** Launch architect, then worker after 1.5s, then qa after 1.5s using setTimeout.\n\nError handling: If no workspace folder, show error. If script not found, show error. Wrap in try/catch.\nTest: Function creates terminal and sends command.",
      "status": "COMPLETED",
      "affectedFiles": [
        "moe-vscode/src/util/AgentLauncher.ts"
      ],
      "startedAt": "2026-02-23T06:28:56.518Z",
      "completedAt": "2026-02-23T06:29:03.455Z",
      "note": "AgentLauncher.ts created with launchAgent() and launchAllAgents() functions. Uses VS Code Terminal API, resolves workspace root, generates workerId, builds terminal command, creates/shows terminal. Terminal names: Moe Planner/Coder/QA. launchAllAgents uses 1.5s staggered timeouts. All wrapped in try/catch.",
      "modifiedFiles": [
        "moe-vscode/src/util/AgentLauncher.ts"
      ]
    },
    {
      "stepId": "step-2",
      "description": "Implement script resolution and command building in AgentLauncher.ts:\n\n**`resolveAgentScript(extensionPath, workspacePath)`:**\n1. Project scripts: check `{workspacePath}/scripts/moe-agent.ps1` (win) or `.sh` (unix)\n2. Bundled scripts: check `{extensionPath}/bundled/scripts/moe-agent.ps1` or `.sh`\n3. Global config: read `~/.moe/config.json`, resolve `{installPath}/scripts/moe-agent.*`\n4. Return `{ scriptPath, envOverrides }` where envOverrides has MOE_DAEMON_PATH + MOE_PROXY_PATH if using bundled/global\n\n**`buildPowerShellCommand(scriptPath, role, workspacePath, workerId, command, team?, envOverrides?)`:**\nReturn: `powershell -NoProfile -ExecutionPolicy Bypass -Command \"$env:MOE_DAEMON_PATH='{path}'; $env:MOE_PROXY_PATH='{path}'; & '{scriptPath}' -Role {role} -Project '{workspacePath}' -WorkerId '{workerId}' -Command '{command}' [-Team '{team}']\"`\n\n**`buildBashCommand(scriptPath, role, workspacePath, workerId, command, team?, envOverrides?)`:**\nReturn: `MOE_DAEMON_PATH='{path}' MOE_PROXY_PATH='{path}' bash '{scriptPath}' --role {role} --project '{workspacePath}' --worker-id '{workerId}' --command '{command}' [--team '{team}']`\n\nUse `fs.existsSync` for script resolution. All paths quoted for spaces.\n\nError handling: Return null from resolveAgentScript if not found. Caller shows error.\nTest: Commands match expected format from JetBrains TerminalAgentLauncher reference.",
      "status": "COMPLETED",
      "affectedFiles": [
        "moe-vscode/src/util/AgentLauncher.ts"
      ],
      "startedAt": "2026-02-23T06:29:03.974Z",
      "completedAt": "2026-02-23T06:29:09.866Z",
      "note": "resolveAgentScript checks workspace-local, bundled, and global (~/.moe/config.json) paths with fs.existsSync. Returns {scriptPath, envOverrides} with MOE_DAEMON_PATH/MOE_PROXY_PATH when using non-local scripts. buildPowerShellCommand and buildBashCommand handle env prefix, quoted paths, and optional --team/Team flag.",
      "modifiedFiles": [
        "moe-vscode/src/util/AgentLauncher.ts"
      ]
    },
    {
      "stepId": "step-3",
      "description": "Add agent launch UI to the board header in BoardViewProvider.ts and wire commands:\n\n1. Add \"Agents\" button to board header: `<button id=\"agentsBtn\">Agents</button>`\n2. On click, post `{ type: 'showAgentMenu' }` to extension\n3. In extension-side handler, show a VS Code QuickPick with items:\n   - `[$(check)] Team Mode` (toggle, persisted in workspaceState)\n   - `Start All Agents (Claude)` / `(Codex)` / `(Gemini)`\n   - `Start Architect` -> sub-picker with Claude/Codex/Gemini/Custom\n   - `Start Worker` -> sub-picker\n   - `Start QA` -> sub-picker\n4. Handle selection: call `AgentLauncher.launchAgent()` or `launchAllAgents()` with appropriate args\n5. For Custom provider: prompt with `showInputBox` for command\n6. Persist last provider in `context.workspaceState` via `get/update`\n\n**Register commands in extension.ts:**\n- `moe.startAgent` -> show role picker then provider picker, launch\n- `moe.startAllAgents` -> show provider picker, launch all\n\nError handling: Check workspace folder exists before launching. Show error if no agent script found.\nTest: Agents button opens menu. Selecting option launches terminal with correct command.",
      "status": "COMPLETED",
      "affectedFiles": [
        "moe-vscode/src/providers/BoardViewProvider.ts",
        "moe-vscode/src/extension.ts"
      ],
      "startedAt": "2026-02-23T06:29:10.384Z",
      "completedAt": "2026-02-23T06:31:29.121Z",
      "note": "Added Agents and Settings (gear) buttons to board header, visible when connected. showAgentMenu delegates to moe.startAgent command. openSettings delegates to moe.openSettings command. Added SettingsPanel import and moe.openSettings command registration in extension.ts. Added moe.openSettings to package.json commands.",
      "modifiedFiles": [
        "moe-vscode/src/providers/BoardViewProvider.ts",
        "moe-vscode/src/extension.ts",
        "moe-vscode/package.json"
      ]
    }
  ],
  "status": "DONE",
  "assignedWorkerId": null,
  "branch": null,
  "prLink": null,
  "reopenCount": 1,
  "reopenReason": "AgentLauncher.ts was created with proper 3-level script resolution, worker ID generation, team mode, and cross-platform command building - BUT it's never imported or used by extension.ts. The moe.startAgent and moe.startAllAgents commands still use the old inline implementation that lacks most DoD features.\n\nFailed DoD items:\n1. \"Menu shows team mode toggle + start all/architect/worker/qa options\" - QuickPick only shows Worker/Architect/QA. No team mode toggle, no \"Start All\" in the menu.\n2. \"Each role option has provider submenu (Claude/Codex/Gemini/Custom)\" - No provider selection. Uses moe.agentCommand config directly.\n3. \"Agent script resolved from project, bundled, or global config paths\" - extension.ts only checks workspace-local scripts/ (line 243). AgentLauncher.ts has 3-level resolution but isn't used.\n4. \"Worker IDs generated with role prefix and random suffix\" - extension.ts commands don't generate worker IDs. AgentLauncher does but isn't called.\n5. \"Team mode passes team name when enabled\" - No team mode in the commands.\n6. \"Last used provider and custom command persisted in workspace state\" - No workspace state persistence.\n\nFix: Import and use AgentLauncher in extension.ts moe.startAgent command. Replace the inline implementation with calls to launchAgent/launchAllAgents. Add QuickPick with team mode toggle, provider selection, and start-all option.",
  "createdBy": "WORKER",
  "parentTaskId": null,
  "priority": "MEDIUM",
  "order": 12,
  "comments": [],
  "hasPendingQuestion": false,
  "createdAt": "2026-02-21T23:05:27.732Z",
  "updatedAt": "2026-02-24T10:00:55.008Z",
  "planSubmittedAt": "2026-02-21T23:23:49.630Z",
  "planApprovedAt": "2026-02-21T23:23:49.632Z",
  "workStartedAt": "2026-02-23T06:28:56.518Z",
  "completedAt": "2026-02-24T09:58:01.303Z",
  "reviewStartedAt": "2026-02-24T09:58:01.303Z",
  "reviewCompletedAt": "2026-02-24T10:00:55.008Z",
  "rejectionDetails": {
    "failedDodItems": [
      "Menu shows team mode toggle + start all/architect/worker/qa options",
      "Each role option has provider submenu (Claude/Codex/Gemini/Custom)",
      "Agent script resolved from project, bundled, or global config paths",
      "Worker IDs generated with role prefix and random suffix",
      "Team mode passes team name when enabled",
      "Last used provider and custom command persisted in workspace state"
    ],
    "issues": [
      {
        "type": "missing_feature",
        "description": "AgentLauncher.ts is created but never imported or called from extension.ts. The moe.startAgent and moe.startAllAgents commands use old inline code without AgentLauncher's features.",
        "file": "moe-vscode/src/extension.ts",
        "line": 220
      },
      {
        "type": "missing_feature",
        "description": "No provider submenu (Claude/Codex/Gemini/Custom) in the QuickPick menu - just uses moe.agentCommand config directly",
        "file": "moe-vscode/src/extension.ts",
        "line": 238
      },
      {
        "type": "missing_feature",
        "description": "No team mode toggle, no workspace state persistence for provider/team settings",
        "file": "moe-vscode/src/extension.ts",
        "line": 220
      },
      {
        "type": "missing_feature",
        "description": "No worker ID generation in the command - AgentLauncher generates them but isn't called",
        "file": "moe-vscode/src/extension.ts",
        "line": 252
      }
    ]
  }
}